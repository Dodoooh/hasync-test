# Comprehensive Diagnostic Dockerfile for Architecture Testing
# Purpose: Identify exact point of failure in better-sqlite3 binary loading

ARG BUILD_FROM=ghcr.io/hassio-addons/base-python/amd64:17.0.0
FROM ${BUILD_FROM}

# ==========================================
# STAGE 1: Base Architecture Verification
# ==========================================
RUN echo "=== STAGE 1: Base Architecture Verification ===" && \
    echo "Architecture: $(uname -m)" && \
    echo "OS: $(cat /etc/os-release | head -n 5)" && \
    echo "Kernel: $(uname -r)" && \
    file /bin/sh && \
    ldd --version && \
    uname -m > /tmp/stage1-arch.txt

# ==========================================
# STAGE 2: Install Node.js
# ==========================================
RUN echo "=== STAGE 2: Node.js Installation ===" && \
    apk add --no-cache \
        nodejs \
        npm \
        python3 \
        make \
        g++ \
        gcc \
        libc-dev \
        linux-headers && \
    echo "Node version: $(node --version)" && \
    echo "NPM version: $(npm --version)" && \
    echo "Python version: $(python3 --version)" && \
    echo "GCC version: $(gcc --version | head -n 1)" && \
    node --version > /tmp/stage2-node.txt && \
    uname -m > /tmp/stage2-arch.txt

# ==========================================
# STAGE 3: Verify Build Tools Architecture
# ==========================================
RUN echo "=== STAGE 3: Build Tools Architecture ===" && \
    file /usr/bin/gcc && \
    file /usr/bin/g++ && \
    file /usr/bin/node && \
    file /usr/bin/python3 && \
    gcc -dumpmachine > /tmp/stage3-gcc-target.txt && \
    node -p "process.arch" > /tmp/stage3-node-arch.txt && \
    uname -m > /tmp/stage3-arch.txt

# ==========================================
# STAGE 4: Minimal better-sqlite3 Test
# ==========================================
WORKDIR /test
RUN echo "=== STAGE 4: Minimal better-sqlite3 Installation ===" && \
    npm init -y && \
    npm install better-sqlite3 --build-from-source && \
    echo "Installation complete" && \
    uname -m > /tmp/stage4-arch.txt

# Verify binary architecture
RUN echo "=== STAGE 4a: Binary Architecture Check ===" && \
    find /test -name "better_sqlite3.node" -exec file {} \; > /tmp/stage4-binary-file.txt && \
    find /test -name "better_sqlite3.node" -exec ls -lh {} \; > /tmp/stage4-binary-size.txt && \
    find /test -name "better_sqlite3.node" -exec readelf -h {} \; > /tmp/stage4-binary-elf.txt 2>&1 || echo "Not an ELF binary" > /tmp/stage4-binary-elf.txt

# Test if binary loads
RUN echo "=== STAGE 4b: Binary Load Test ===" && \
    node -e "try { const db = require('better-sqlite3'); console.log('SUCCESS: Module loaded'); } catch(e) { console.log('FAILED:', e.message); process.exit(1); }" > /tmp/stage4-load-test.txt 2>&1 || echo "LOAD FAILED" >> /tmp/stage4-load-test.txt

# ==========================================
# STAGE 5: Architecture Consistency Check
# ==========================================
RUN echo "=== STAGE 5: Architecture Consistency Check ===" && \
    echo "System Arch: $(uname -m)" && \
    echo "Node Arch: $(node -p 'process.arch')" && \
    echo "GCC Target: $(gcc -dumpmachine)" && \
    echo "Binary Arch: $(file /test/node_modules/better-sqlite3/build/Release/better_sqlite3.node | cut -d: -f2)" && \
    echo "=== Consistency Report ===" > /tmp/stage5-consistency.txt && \
    echo "System: $(uname -m)" >> /tmp/stage5-consistency.txt && \
    echo "Node: $(node -p 'process.arch')" >> /tmp/stage5-consistency.txt && \
    echo "GCC: $(gcc -dumpmachine)" >> /tmp/stage5-consistency.txt && \
    echo "Binary: $(file /test/node_modules/better-sqlite3/build/Release/better_sqlite3.node)" >> /tmp/stage5-consistency.txt

# ==========================================
# STAGE 6: Environment Variables Check
# ==========================================
RUN echo "=== STAGE 6: Environment Variables ===" && \
    env | grep -i arch > /tmp/stage6-env-arch.txt || echo "No arch env vars" > /tmp/stage6-env-arch.txt && \
    env | grep -i node > /tmp/stage6-env-node.txt || echo "No node env vars" > /tmp/stage6-env-node.txt && \
    npm config list > /tmp/stage6-npm-config.txt

# ==========================================
# STAGE 7: Collect All Diagnostics
# ==========================================
RUN echo "=== STAGE 7: Diagnostic Summary ===" && \
    cat /tmp/stage1-arch.txt /tmp/stage2-arch.txt /tmp/stage3-arch.txt /tmp/stage4-arch.txt > /tmp/arch-timeline.txt && \
    echo "=== DIAGNOSTIC REPORT ===" > /tmp/diagnostic-report.txt && \
    echo "" >> /tmp/diagnostic-report.txt && \
    echo "STAGE 1 - Base Architecture:" >> /tmp/diagnostic-report.txt && \
    cat /tmp/stage1-arch.txt >> /tmp/diagnostic-report.txt && \
    echo "" >> /tmp/diagnostic-report.txt && \
    echo "STAGE 2 - After Node.js Install:" >> /tmp/diagnostic-report.txt && \
    cat /tmp/stage2-node.txt >> /tmp/diagnostic-report.txt && \
    cat /tmp/stage2-arch.txt >> /tmp/diagnostic-report.txt && \
    echo "" >> /tmp/diagnostic-report.txt && \
    echo "STAGE 3 - Build Tools:" >> /tmp/diagnostic-report.txt && \
    cat /tmp/stage3-gcc-target.txt >> /tmp/diagnostic-report.txt && \
    cat /tmp/stage3-node-arch.txt >> /tmp/diagnostic-report.txt && \
    echo "" >> /tmp/diagnostic-report.txt && \
    echo "STAGE 4 - Binary Analysis:" >> /tmp/diagnostic-report.txt && \
    cat /tmp/stage4-binary-file.txt >> /tmp/diagnostic-report.txt && \
    cat /tmp/stage4-binary-elf.txt >> /tmp/diagnostic-report.txt && \
    echo "" >> /tmp/diagnostic-report.txt && \
    echo "STAGE 4b - Load Test:" >> /tmp/diagnostic-report.txt && \
    cat /tmp/stage4-load-test.txt >> /tmp/diagnostic-report.txt && \
    echo "" >> /tmp/diagnostic-report.txt && \
    echo "STAGE 5 - Consistency:" >> /tmp/diagnostic-report.txt && \
    cat /tmp/stage5-consistency.txt >> /tmp/diagnostic-report.txt && \
    cat /tmp/diagnostic-report.txt

# Final test command
CMD ["sh", "-c", "cat /tmp/diagnostic-report.txt && echo '=== Final Load Test ===' && node -e \"const db = require('better-sqlite3')(':memory:'); console.log('SUCCESS: Database created'); db.close();\""]
