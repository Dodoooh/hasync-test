openapi: 3.0.0
info:
  title: HAsync Backend API
  version: 1.3.7
  description: |
    HAsync - Home Assistant Manager Backend API

    Advanced Home Assistant management interface with client pairing and entity synchronization.

    **Features:**
    - Client authentication and pairing
    - Area and entity management
    - Home Assistant configuration
    - CSRF protection

  contact:
    name: HAsync Support
    url: https://github.com/Dodoooh/hasync-test

servers:
  - url: http://localhost:8099/api
    description: Local development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Authentication
    description: User authentication and JWT tokens
  - name: CSRF
    description: CSRF token generation
  - name: Pairing
    description: Client pairing with PIN
  - name: Clients
    description: Paired client management
  - name: Areas
    description: Area management
  - name: Entities
    description: Entity management
  - name: Dashboards
    description: Dashboard management
  - name: Configuration
    description: Home Assistant configuration
  - name: Privacy
    description: Privacy policy and user data

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      description: Check if the server is running and healthy
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  timestamp:
                    type: string
                    format: date-time
                  uptime:
                    type: number
                    description: Server uptime in seconds
                  version:
                    type: string
                    example: 1.3.7

  /csrf-token:
    get:
      tags: [CSRF]
      summary: Get CSRF token
      description: Generate a CSRF token for form submissions
      responses:
        '200':
          description: CSRF token generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  csrfToken:
                    type: string
                    example: 7xYz9AbC-dEfG2HiJ3kLmN4oPqR5sTuV6wXy

  /auth/login:
    post:
      tags: [Authentication]
      summary: User login
      description: Authenticate user with username and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: admin
                password:
                  type: string
                  format: password
                  example: password123
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                    description: JWT access token (15 minutes)
                  refreshToken:
                    type: string
                    description: JWT refresh token (7 days)
                  user:
                    type: object
                    properties:
                      username:
                        type: string
                      role:
                        type: string
        '401':
          description: Invalid credentials
        '429':
          description: Rate limit exceeded

  /auth/verify:
    get:
      tags: [Authentication]
      summary: Verify JWT token
      description: Verify the validity of a JWT access token
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Token is valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  user:
                    type: object
                    properties:
                      username:
                        type: string
                      role:
                        type: string
        '401':
          description: Token invalid or expired

  /pairing/create:
    post:
      tags: [Pairing]
      summary: Create pairing PIN
      description: Generate a 6-digit PIN for client pairing (valid for 5 minutes)
      responses:
        '200':
          description: PIN generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  pin:
                    type: string
                    example: "123456"
                  expiresAt:
                    type: string
                    format: date-time

  /clients:
    get:
      tags: [Clients]
      summary: List all paired clients
      description: Get all paired clients with their status
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of clients
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    name:
                      type: string
                    pairedAt:
                      type: string
                      format: date-time
                    lastSeen:
                      type: string
                      format: date-time

  /areas:
    get:
      tags: [Areas]
      summary: List all areas
      description: Get all configured areas
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of areas
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    name:
                      type: string
                    order:
                      type: number

    post:
      tags: [Areas]
      summary: Create new area
      description: Create a new area
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  example: Living Room
      responses:
        '201':
          description: Area created
        '400':
          description: Invalid input

  /areas/{id}:
    patch:
      tags: [Areas]
      summary: Update area
      description: Update area properties
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
      responses:
        '200':
          description: Area updated
        '404':
          description: Area not found

    put:
      tags: [Areas]
      summary: Replace area
      description: Replace entire area
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Area replaced
        '404':
          description: Area not found

    delete:
      tags: [Areas]
      summary: Delete area
      description: Delete an area
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Area deleted
        '404':
          description: Area not found

  /areas/{id}/entities:
    get:
      tags: [Areas]
      summary: Get area entities
      description: Get all entities in an area
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of entities
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
        '404':
          description: Area not found

  /areas/{id}/reorder:
    patch:
      tags: [Areas]
      summary: Reorder area
      description: Change area display order
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                order:
                  type: number
      responses:
        '200':
          description: Order updated
        '404':
          description: Area not found

  /areas/{id}/toggle:
    patch:
      tags: [Areas]
      summary: Toggle area visibility
      description: Show/hide area
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Visibility toggled
        '404':
          description: Area not found

  /entities:
    get:
      tags: [Entities]
      summary: List all entities
      description: Get all configured entities
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of entities
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /dashboards:
    get:
      tags: [Dashboards]
      summary: List dashboards
      description: Get all configured dashboards
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of dashboards
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /config/ha:
    get:
      tags: [Configuration]
      summary: Get Home Assistant config
      description: Get current Home Assistant configuration
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Configuration retrieved
          content:
            application/json:
              schema:
                type: object

    post:
      tags: [Configuration]
      summary: Update Home Assistant config
      description: Update Home Assistant configuration
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
                  format: uri
                  example: http://homeassistant.local:8123
                token:
                  type: string
      responses:
        '200':
          description: Configuration updated
        '400':
          description: Invalid configuration

  /privacy-policy:
    get:
      tags: [Privacy]
      summary: Get privacy policy
      description: Get the privacy policy text
      responses:
        '200':
          description: Privacy policy
          content:
            text/plain:
              schema:
                type: string

  /user/consent:
    get:
      tags: [Privacy]
      summary: Get user consent status
      description: Check if user has given consent
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Consent status
          content:
            application/json:
              schema:
                type: object
                properties:
                  consented:
                    type: boolean

    post:
      tags: [Privacy]
      summary: Give user consent
      description: User gives consent for data processing
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Consent recorded

  /user/data-export:
    get:
      tags: [Privacy]
      summary: Export user data
      description: Export all user data (GDPR)
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User data export
          content:
            application/json:
              schema:
                type: object

  /user/data-delete:
    delete:
      tags: [Privacy]
      summary: Delete user data
      description: Delete all user data (GDPR right to be forgotten)
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User data deleted

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
