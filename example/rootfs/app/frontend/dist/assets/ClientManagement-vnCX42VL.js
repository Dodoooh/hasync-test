import{i as e,j as s,c as n,G as t,T as a,A as i,H as l,U as r,h as c,a3 as d,P as o,a4 as h,a5 as u,a6 as x,a7 as j,a8 as f,E as m,I as p,S as v,M as g,N as y,O as C,t as b,a9 as S,R as k,B as z}from"./mui-bZH-AYFI.js";import{r as T}from"./vendor-DtzNP0b0.js";import{d as w,a as A}from"./Delete-Bqi5MThO.js";import{r as M,u as _,b as I,a as H}from"./index-fo0tzV7o.js";import{b as O}from"./helpers-F_j2KFUt.js";import"./state-MbgKLSXQ.js";import"./utils-D1Jy8hEJ.js";var D={},F=e;Object.defineProperty(D,"__esModule",{value:!0});var P=D.default=void 0,W=F(M()),E=s;P=D.default=(0,W.default)((0,E.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2M4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9C4.63 15.55 4 13.85 4 12m8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1C19.37 8.45 20 10.15 20 12c0 4.42-3.58 8-8 8"}),"Block");var L={},N=e;Object.defineProperty(L,"__esModule",{value:!0});var $=L.default=void 0,B=N(M()),R=s;$=L.default=(0,B.default)((0,R.jsx)("path",{d:"M16 1H8C6.34 1 5 2.34 5 4v16c0 1.66 1.34 3 3 3h8c1.66 0 3-1.34 3-3V4c0-1.66-1.34-3-3-3m-2 20h-4v-1h4zm3.25-3H6.75V4h10.5z"}),"PhoneAndroid");var V={},U=e;Object.defineProperty(V,"__esModule",{value:!0});var G=V.default=void 0,q=U(M()),J=s;G=V.default=(0,q.default)((0,J.jsx)("path",{d:"M21 4H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 1.99-.9 1.99-2L23 6c0-1.1-.9-2-2-2m-2 14H5V6h14z"}),"Tablet");var K={},Q=e;Object.defineProperty(K,"__esModule",{value:!0});var X=K.default=void 0,Y=Q(M()),Z=s;X=K.default=(0,Y.default)((0,Z.jsx)("path",{d:"M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2zM4 6h16v10H4z"}),"Computer");const ee=e=>{switch(e){case"phone":return s.jsx($,{fontSize:"small"});case"tablet":return s.jsx(G,{fontSize:"small"});case"desktop":return s.jsx(X,{fontSize:"small"})}},se=e=>{switch(e){case"online":return"success";case"offline":return"default";case"pairing":return"warning"}},ne=({open:e,client:i,areas:l,onClose:r,onSave:d})=>{const[o,h]=T.useState(""),[u,x]=T.useState([]),[j,f]=T.useState(!1);T.useEffect(()=>{if(i){h(i.name);const e=l.filter(e=>i.assignedAreas.includes(e.id));x(e)}},[i,l]);return s.jsxs(g,{open:e,onClose:r,maxWidth:"sm",fullWidth:!0,children:[s.jsx(y,{children:"Edit Client"}),s.jsx(C,{children:s.jsxs(t,{spacing:3,sx:{mt:1},children:[s.jsx(b,{label:"Client Name",value:o,onChange:e=>h(e.target.value),fullWidth:!0,autoFocus:!0}),s.jsx(S,{multiple:!0,options:l,value:u,onChange:(e,s)=>x(s),getOptionLabel:e=>e.name,renderInput:e=>s.jsx(b,{...e,label:"Assigned Areas",placeholder:"Select areas..."}),renderTags:(e,n)=>e.map((e,t)=>s.jsx(m,{label:e.name,...n({index:t}),size:"small"}))}),i&&s.jsxs(n,{children:[s.jsxs(a,{variant:"caption",color:"text.secondary",children:["Device Type: ",i.deviceType]}),s.jsx("br",{}),s.jsxs(a,{variant:"caption",color:"text.secondary",children:["Status: ",i.status]})]})]})}),s.jsxs(k,{children:[s.jsx(z,{onClick:r,disabled:j,children:"Cancel"}),s.jsx(z,{onClick:async()=>{if(i){f(!0);try{await d(i.id,{name:o,assignedAreas:u.map(e=>e.id)}),r()}catch(e){console.error("Failed to save client:",e)}finally{f(!1)}}},variant:"contained",disabled:j||!o.trim(),children:j?s.jsx(c,{size:24}):"Save"})]})]})},te=({open:e,title:n,message:t,confirmText:a,onConfirm:l,onCancel:r,loading:d=!1})=>s.jsxs(g,{open:e,onClose:r,maxWidth:"sm",fullWidth:!0,children:[s.jsx(y,{children:n}),s.jsx(C,{children:s.jsx(i,{severity:"warning",sx:{mt:1},children:t})}),s.jsxs(k,{children:[s.jsx(z,{onClick:r,disabled:d,children:"Cancel"}),s.jsx(z,{onClick:l,variant:"contained",color:"error",disabled:d,children:d?s.jsx(c,{size:24}):a})]})]}),ae=()=>{const{areas:e}=_(),{on:g}=I(),[y,C]=T.useState([]),[b,S]=T.useState(!0),[k,z]=T.useState(null),[M,D]=T.useState(!1),[F,W]=T.useState(null),[E,L]=T.useState(!1),[N,$]=T.useState(!1),[B,R]=T.useState(!1),[V,U]=T.useState({open:!1,message:"",severity:"success"}),G=(e,s)=>{U({open:!0,message:e,severity:s})},q=T.useCallback(async()=>{S(!0),z(null);try{const e=await H.getClients();C(e)}catch(e){z(e.message||"Failed to load clients"),console.error("Failed to load clients:",e)}finally{S(!1)}},[]);T.useEffect(()=>{q()},[q]),T.useEffect(()=>{const e=g("client_connected",e=>{C(s=>{const n=s.findIndex(s=>s.id===e.client.id);if(n>=0){const t=[...s];return t[n]=e.client,t}return[...s,e.client]}),G(`Client "${e.client.name}" connected`,"success")}),s=g("client_disconnected",e=>{C(s=>{const n=s.findIndex(s=>s.id===e.client.id);if(n>=0){const t=[...s];return t[n]=e.client,t}return s}),G(`Client "${e.client.name}" disconnected`,"success")}),n=g("area_added",e=>{C(s=>s.map(s=>s.id===e.clientId?{...s,assignedAreas:[...s.assignedAreas,e.areaId]}:s))}),t=g("area_removed",e=>{C(s=>s.map(s=>s.id===e.clientId?{...s,assignedAreas:s.assignedAreas.filter(s=>s!==e.areaId)}:s))});return()=>{e(),s(),n(),t()}},[g]);return s.jsxs(n,{children:[s.jsxs(t,{spacing:3,children:[s.jsxs(n,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[s.jsx(a,{variant:"h5",children:"Client Management"}),s.jsxs(a,{variant:"body2",color:"text.secondary",children:[y.length," client",1!==y.length?"s":""," total"]})]}),k&&s.jsx(i,{severity:"error",children:k}),s.jsx(l,{children:s.jsx(r,{children:b?s.jsx(n,{display:"flex",justifyContent:"center",py:4,children:s.jsx(c,{})}):0===y.length?s.jsx(a,{color:"text.secondary",align:"center",py:4,children:"No clients connected yet. Use the Pairing Wizard to add new clients."}):s.jsx(d,{component:o,variant:"outlined",children:s.jsxs(h,{children:[s.jsx(u,{children:s.jsxs(x,{children:[s.jsx(j,{children:"Name"}),s.jsx(j,{children:"Device Type"}),s.jsx(j,{children:"Assigned Areas"}),s.jsx(j,{children:"Last Seen"}),s.jsx(j,{children:"Status"}),s.jsx(j,{align:"right",children:"Actions"})]})}),s.jsx(f,{children:y.map(i=>{return s.jsxs(x,{hover:!0,children:[s.jsx(j,{children:s.jsxs(n,{display:"flex",alignItems:"center",gap:1,children:[ee(i.deviceType),s.jsx(a,{variant:"body2",children:i.name})]})}),s.jsx(j,{children:s.jsx(a,{variant:"body2",sx:{textTransform:"capitalize"},children:i.deviceType})}),s.jsx(j,{children:i.assignedAreas.length>0?s.jsx(n,{display:"flex",gap:.5,flexWrap:"wrap",children:(l=i.assignedAreas,l.map(s=>{var n;return null==(n=e.find(e=>e.id===s))?void 0:n.name}).filter(Boolean)).map((e,n)=>s.jsx(m,{label:e,size:"small"},n))}):s.jsx(a,{variant:"body2",color:"text.secondary",children:"None"})}),s.jsx(j,{children:s.jsx(a,{variant:"body2",children:O(i.lastSeen)})}),s.jsx(j,{children:s.jsx(m,{label:i.status,color:se(i.status),size:"small"})}),s.jsx(j,{align:"right",children:s.jsxs(t,{direction:"row",spacing:1,justifyContent:"flex-end",children:[s.jsx(p,{size:"small",onClick:()=>(e=>{W(e),D(!0)})(i),title:"Edit client",children:s.jsx(w,{fontSize:"small"})}),s.jsx(p,{size:"small",onClick:()=>(e=>{W(e),L(!0)})(i),title:"Revoke token",color:"warning",children:s.jsx(P,{fontSize:"small"})}),s.jsx(p,{size:"small",onClick:()=>(e=>{W(e),$(!0)})(i),title:"Delete client",color:"error",children:s.jsx(A,{fontSize:"small"})})]})})]},i.id);var l})})]})})})}),s.jsx(l,{children:s.jsxs(r,{children:[s.jsx(a,{variant:"subtitle2",gutterBottom:!0,children:"Statistics"}),s.jsxs(t,{direction:"row",spacing:2,children:[s.jsx(m,{label:`Total: ${y.length}`,variant:"outlined"}),s.jsx(m,{label:`Online: ${y.filter(e=>"online"===e.status).length}`,color:"success",variant:"outlined"}),s.jsx(m,{label:`Offline: ${y.filter(e=>"offline"===e.status).length}`,variant:"outlined"})]})]})})]}),s.jsx(ne,{open:M,client:F,areas:e,onClose:()=>{D(!1),W(null)},onSave:async(e,s)=>{try{const n=await H.updateClient(e,s);C(s=>s.map(s=>s.id===e?n:s)),G("Client updated successfully","success")}catch(n){throw G(n.message||"Failed to update client","error"),n}}}),s.jsx(te,{open:E,title:"Revoke Client Token",message:"This will disconnect the client immediately and invalidate its access token. The client will need to be re-paired to reconnect.",confirmText:"Revoke Token",onConfirm:async()=>{if(F){R(!0);try{await H.revokeClientToken(F.id),C(e=>e.map(e=>e.id===F.id?{...e,status:"offline"}:e)),G("Client token revoked successfully","success"),L(!1),W(null)}catch(e){G(e.message||"Failed to revoke token","error")}finally{R(!1)}}},onCancel:()=>{L(!1),W(null)},loading:B}),s.jsx(te,{open:N,title:"Delete Client",message:"This will permanently delete the client and all its associated data. This action cannot be undone.",confirmText:"Delete Client",onConfirm:async()=>{if(F){R(!0);try{await H.deleteClient(F.id),C(e=>e.filter(e=>e.id!==F.id)),G("Client deleted successfully","success"),$(!1),W(null)}catch(e){G(e.message||"Failed to delete client","error")}finally{R(!1)}}},onCancel:()=>{$(!1),W(null)},loading:B}),s.jsx(v,{open:V.open,autoHideDuration:6e3,onClose:()=>U({...V,open:!1}),anchorOrigin:{vertical:"bottom",horizontal:"right"},children:s.jsx(i,{onClose:()=>U({...V,open:!1}),severity:V.severity,variant:"filled",children:V.message})})]})};export{ae as ClientManagement};
