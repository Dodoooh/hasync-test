import{j as s,c as e,T as t,P as a,G as n,A as o,h as i,ag as r,ah as c,E as l,Z as d,t as u,v as g,I as h,ai as m,V as x,w as j,B as p,aj as f}from"./mui-bZH-AYFI.js";import{r as v}from"./vendor-DtzNP0b0.js";import{u as y,a as k}from"./index-C0CMstuU.js";import"./state-MbgKLSXQ.js";import"./utils-D1Jy8hEJ.js";const A=()=>{const{ingressUrl:A,accessToken:C,setAuth:b}=y(),[S,L]=v.useState(A),[T,H]=v.useState(C),[w,U]=v.useState(!1),[z,B]=v.useState({status:"idle",message:""}),[I,R]=v.useState(!1),[E,P]=v.useState(!1),[q,F]=v.useState(""),[G,N]=v.useState("");v.useEffect(()=>{(async()=>{try{const s=await k.getHAConfig();s.url&&L(s.url),s.token&&H(s.token),console.log("Loaded saved config from database")}catch(s){console.error("Failed to load saved config:",s)}})()},[]),v.useEffect(()=>{A&&L(A),C&&H(C)},[A,C]);const W=s=>{if(!s.trim())return F("URL is required"),!1;try{const e=new URL(s);return["http:","https:"].includes(e.protocol)?(F(""),!0):(F("URL must start with http:// or https://"),!1)}catch{return F("Invalid URL format (e.g., http://homeassistant.local:8123)"),!1}},M=s=>s.trim()?s.length<20?(N("Token appears to be too short"),!1):(N(""),!0):(N("Access token is required"),!1);return s.jsxs(e,{children:[s.jsx(t,{variant:"h4",gutterBottom:!0,children:"Home Assistant Settings"}),s.jsx(t,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Configure connection to your Home Assistant instance"}),s.jsx(a,{sx:{p:3,mt:3},children:s.jsxs(n,{spacing:3,children:["idle"!==z.status&&s.jsx(o,{severity:"success"===z.status?"success":"error"===z.status?"error":"info",icon:"testing"===z.status?s.jsx(i,{size:20}):"success"===z.status?s.jsx(r,{}):s.jsx(c,{}),children:z.message}),E&&s.jsx(o,{severity:"success",icon:s.jsx(r,{}),children:"Settings saved successfully!"}),s.jsxs(e,{children:[s.jsx(t,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Current Status"}),s.jsxs(n,{direction:"row",spacing:1,alignItems:"center",children:[s.jsx(l,{label:A||"Not configured",color:A?"success":"default",size:"small"}),s.jsx(l,{label:C?"Token configured":"No token",color:C?"success":"default",size:"small"})]})]}),s.jsx(d,{}),s.jsx(u,{label:"Home Assistant URL",placeholder:"http://homeassistant.local:8123",value:S,onChange:s=>{const e=s.target.value;L(e),P(!1),B({status:"idle",message:""}),q&&F("")},onBlur:()=>{S.trim()&&W(S)},error:!!q,helperText:q||"Enter the full URL of your Home Assistant instance",fullWidth:!0,required:!0,disabled:I||"testing"===z.status,InputProps:{endAdornment:S&&s.jsx(g,{position:"end",children:s.jsx(h,{edge:"end",onClick:()=>{L(""),F("")},size:"small",children:s.jsx(m,{})})})}}),s.jsx(u,{label:"Long-Lived Access Token",placeholder:"Enter your Home Assistant access token",value:T,onChange:s=>{const e=s.target.value;H(e),P(!1),B({status:"idle",message:""}),G&&N("")},onBlur:()=>{T.trim()&&M(T)},error:!!G,helperText:G||"Create a long-lived access token in Home Assistant Profile settings",fullWidth:!0,required:!0,type:w?"text":"password",disabled:I||"testing"===z.status,InputProps:{endAdornment:s.jsx(g,{position:"end",children:s.jsx(h,{edge:"end",onClick:()=>U(!w),size:"small",children:w?s.jsx(x,{}):s.jsx(j,{})})})}}),s.jsx(d,{}),s.jsxs(n,{direction:"row",spacing:2,children:[s.jsx(p,{variant:"contained",color:"primary",startIcon:I?s.jsx(i,{size:20}):s.jsx(f,{}),onClick:async()=>{const s=W(S),e=M(T);if(s&&e){R(!0),P(!1);try{await k.saveHAConfig(S,T),P(!0),B({status:"success",message:"Settings saved to database! Settings are now persistent."}),setTimeout(()=>{P(!1)},3e3)}catch(t){console.error("Failed to save settings:",t),B({status:"error",message:t.message||"Failed to save settings"})}finally{R(!1)}}},disabled:I||"testing"===z.status||!S.trim()||!T.trim()||!!q||!!G,children:I?"Saving...":"Save Settings"}),s.jsx(p,{variant:"outlined",color:"secondary",startIcon:"testing"===z.status?s.jsx(i,{size:20}):s.jsx(r,{}),onClick:async()=>{const s=W(S),e=M(T);if(s&&e){B({status:"testing",message:"Testing connection..."});try{k.setAuth(S,T),await k.healthCheck(),B({status:"success",message:"Connection successful! Home Assistant is reachable."})}catch(t){console.error("Connection test failed:",t),B({status:"error",message:t.message||"Failed to connect to Home Assistant. Check URL and token."}),k.setAuth(A,C)}}else B({status:"error",message:"Please fix validation errors before testing"})},disabled:I||"testing"===z.status||!S.trim()||!T.trim()||!!q||!!G,children:"testing"===z.status?"Testing...":"Test Connection"})]}),s.jsxs(e,{sx:{mt:2},children:[s.jsx(t,{variant:"subtitle2",gutterBottom:!0,children:"How to get a Long-Lived Access Token:"}),s.jsxs(t,{variant:"body2",color:"text.secondary",component:"ol",sx:{pl:2},children:[s.jsx("li",{children:"Open Home Assistant"}),s.jsx("li",{children:"Click on your profile (bottom left)"}),s.jsx("li",{children:'Scroll down to "Long-Lived Access Tokens"'}),s.jsx("li",{children:'Click "Create Token"'}),s.jsx("li",{children:'Give it a name (e.g., "HAsync Management")'}),s.jsx("li",{children:"Copy the token and paste it above"})]})]})]})})]})};export{A as Settings};
