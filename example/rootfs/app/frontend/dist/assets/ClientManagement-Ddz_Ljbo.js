import{i as e,j as s,c as n,G as t,T as a,A as i,H as l,U as r,h as c,a3 as o,P as d,a4 as h,a5 as x,a6 as u,a7 as j,a8 as m,E as f,I as p,S as v,M as g,N as y,O as C,t as k,a9 as S,R as b,B as T}from"./mui-bZH-AYFI.js";import{r as A}from"./vendor-DtzNP0b0.js";import{d as z,a as w}from"./Delete-U840tSWU.js";import{r as H,u as M,b as _,a as I}from"./index-C0CMstuU.js";import{d as O}from"./CheckCircle-DaUrYvHB.js";import{b as F}from"./helpers-F_j2KFUt.js";import"./state-MbgKLSXQ.js";import"./utils-D1Jy8hEJ.js";var D={},L=e;Object.defineProperty(D,"__esModule",{value:!0});var W=D.default=void 0,P=L(H()),E=s;W=D.default=(0,P.default)((0,E.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2M4 12c0-4.42 3.58-8 8-8 1.85 0 3.55.63 4.9 1.69L5.69 16.9C4.63 15.55 4 13.85 4 12m8 8c-1.85 0-3.55-.63-4.9-1.69L18.31 7.1C19.37 8.45 20 10.15 20 12c0 4.42-3.58 8-8 8"}),"Block");var N={},J=e;Object.defineProperty(N,"__esModule",{value:!0});var V=N.default=void 0,$=J(H()),B=s;V=N.default=(0,$.default)((0,B.jsx)("path",{d:"M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2"}),"VpnKey");var R={},U=e;Object.defineProperty(R,"__esModule",{value:!0});var G=R.default=void 0,K=U(H()),Q=s;G=R.default=(0,K.default)((0,Q.jsx)("path",{d:"M16 1H8C6.34 1 5 2.34 5 4v16c0 1.66 1.34 3 3 3h8c1.66 0 3-1.34 3-3V4c0-1.66-1.34-3-3-3m-2 20h-4v-1h4zm3.25-3H6.75V4h10.5z"}),"PhoneAndroid");var X={},q=e;Object.defineProperty(X,"__esModule",{value:!0});var Y=X.default=void 0,Z=q(H()),ee=s;Y=X.default=(0,Z.default)((0,ee.jsx)("path",{d:"M21 4H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 1.99-.9 1.99-2L23 6c0-1.1-.9-2-2-2m-2 14H5V6h14z"}),"Tablet");var se={},ne=e;Object.defineProperty(se,"__esModule",{value:!0});var te=se.default=void 0,ae=ne(H()),ie=s;te=se.default=(0,ae.default)((0,ie.jsx)("path",{d:"M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2zM4 6h16v10H4z"}),"Computer");const le=e=>{switch(e){case"phone":return s.jsx(G,{fontSize:"small"});case"tablet":return s.jsx(Y,{fontSize:"small"});case"desktop":return s.jsx(te,{fontSize:"small"})}},re=e=>{switch(e){case"online":return"success";case"offline":return"default";case"pairing":return"warning"}},ce=({open:e,client:i,areas:l,onClose:r,onSave:o})=>{const[d,h]=A.useState(""),[x,u]=A.useState([]),[j,m]=A.useState(!1);A.useEffect(()=>{if(i){h(i.name);const e=l.filter(e=>i.assignedAreas.includes(e.id));u(e)}},[i,l]);return s.jsxs(g,{open:e,onClose:r,maxWidth:"sm",fullWidth:!0,children:[s.jsx(y,{children:"Edit Client"}),s.jsx(C,{children:s.jsxs(t,{spacing:3,sx:{mt:1},children:[s.jsx(k,{label:"Client Name",value:d,onChange:e=>h(e.target.value),fullWidth:!0,autoFocus:!0}),s.jsx(S,{multiple:!0,options:l,value:x,onChange:(e,s)=>u(s),getOptionLabel:e=>e.name,renderInput:e=>s.jsx(k,{...e,label:"Assigned Areas",placeholder:"Select areas..."}),renderTags:(e,n)=>e.map((e,t)=>s.jsx(f,{label:e.name,...n({index:t}),size:"small"}))}),i&&s.jsxs(n,{children:[s.jsxs(a,{variant:"caption",color:"text.secondary",children:["Device Type: ",i.deviceType]}),s.jsx("br",{}),s.jsxs(a,{variant:"caption",color:"text.secondary",children:["Status: ",i.status]})]})]})}),s.jsxs(b,{children:[s.jsx(T,{onClick:r,disabled:j,children:"Cancel"}),s.jsx(T,{onClick:async()=>{if(i){m(!0);try{await o(i.id,{name:d,assignedAreas:x.map(e=>e.id)}),r()}catch(e){console.error("Failed to save client:",e)}finally{m(!1)}}},variant:"contained",disabled:j||!d.trim(),children:j?s.jsx(c,{size:24}):"Save"})]})]})},oe=({open:e,title:n,message:t,confirmText:a,onConfirm:l,onCancel:r,loading:o=!1})=>s.jsxs(g,{open:e,onClose:r,maxWidth:"sm",fullWidth:!0,children:[s.jsx(y,{children:n}),s.jsx(C,{children:s.jsx(i,{severity:"warning",sx:{mt:1},children:t})}),s.jsxs(b,{children:[s.jsx(T,{onClick:r,disabled:o,children:"Cancel"}),s.jsx(T,{onClick:l,variant:"contained",color:"error",disabled:o,children:o?s.jsx(c,{size:24}):a})]})]}),de=({open:e,client:l,onClose:r,onSave:o})=>{const[d,h]=A.useState(""),[x,u]=A.useState(!1);A.useEffect(()=>{e||h("")},[e]);return s.jsxs(g,{open:e,onClose:r,maxWidth:"sm",fullWidth:!0,children:[s.jsx(y,{children:"Add Home Assistant Token"}),s.jsx(C,{children:s.jsxs(t,{spacing:3,sx:{mt:1},children:[s.jsx(i,{severity:"info",children:"Enter a long-lived access token from Home Assistant for this client. The client will use this token to access Home Assistant independently."}),s.jsx(k,{label:"Home Assistant Token",value:d,onChange:e=>h(e.target.value),fullWidth:!0,autoFocus:!0,multiline:!0,rows:4,placeholder:"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",helperText:"Get a long-lived token from Home Assistant Profile → Security → Long-Lived Access Tokens"}),l&&s.jsxs(n,{children:[s.jsxs(a,{variant:"caption",color:"text.secondary",children:["Client: ",l.name]}),s.jsx("br",{}),s.jsxs(a,{variant:"caption",color:"text.secondary",children:["Device: ",l.deviceType]}),l.hasHaToken&&l.haTokenSetAt&&s.jsxs(s.Fragment,{children:[s.jsx("br",{}),s.jsxs(a,{variant:"caption",color:"success.main",children:["✓ Token already set on ",new Date(l.haTokenSetAt).toLocaleString()]})]})]})]})}),s.jsxs(b,{children:[s.jsx(T,{onClick:r,disabled:x,children:"Cancel"}),s.jsx(T,{onClick:async()=>{if(l&&d.trim()){u(!0);try{await o(l.id,d.trim()),r()}catch(e){console.error("Failed to set HA token:",e)}finally{u(!1)}}},variant:"contained",disabled:x||!d.trim(),startIcon:x?s.jsx(c,{size:20}):s.jsx(V,{}),children:x?"Setting Token...":"Set Token"})]})]})},he=()=>{const{areas:e}=M(),{on:g}=_(),[y,C]=A.useState([]),[k,S]=A.useState(!0),[b,T]=A.useState(null),[H,D]=A.useState(!1),[L,P]=A.useState(!1),[E,N]=A.useState(null),[J,$]=A.useState(!1),[B,R]=A.useState(!1),[U,G]=A.useState(!1),[K,Q]=A.useState({open:!1,message:"",severity:"success"}),X=(e,s)=>{Q({open:!0,message:e,severity:s})},q=A.useCallback(async()=>{S(!0),T(null);try{const e=await I.getClients();C(e)}catch(e){T(e.message||"Failed to load clients"),console.error("Failed to load clients:",e)}finally{S(!1)}},[]);A.useEffect(()=>{q()},[q]),A.useEffect(()=>{const e=g("client_connected",e=>{C(s=>{const n=s.findIndex(s=>s.id===e.client.id);if(n>=0){const t=[...s];return t[n]=e.client,t}return[...s,e.client]}),X(`Client "${e.client.name}" connected`,"success")}),s=g("client_disconnected",e=>{C(s=>{const n=s.findIndex(s=>s.id===e.client.id);if(n>=0){const t=[...s];return t[n]=e.client,t}return s}),X(`Client "${e.client.name}" disconnected`,"success")}),n=g("area_added",e=>{C(s=>s.map(s=>s.id===e.clientId?{...s,assignedAreas:[...s.assignedAreas,e.areaId]}:s))}),t=g("area_removed",e=>{C(s=>s.map(s=>s.id===e.clientId?{...s,assignedAreas:s.assignedAreas.filter(s=>s!==e.areaId)}:s))});return()=>{e(),s(),n(),t()}},[g]);return s.jsxs(n,{children:[s.jsxs(t,{spacing:3,children:[s.jsxs(n,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[s.jsx(a,{variant:"h5",children:"Client Management"}),s.jsxs(a,{variant:"body2",color:"text.secondary",children:[y.length," client",1!==y.length?"s":""," total"]})]}),b&&s.jsx(i,{severity:"error",children:b}),s.jsx(l,{children:s.jsx(r,{children:k?s.jsx(n,{display:"flex",justifyContent:"center",py:4,children:s.jsx(c,{})}):0===y.length?s.jsx(a,{color:"text.secondary",align:"center",py:4,children:"No clients connected yet. Use the Pairing Wizard to add new clients."}):s.jsx(o,{component:d,variant:"outlined",children:s.jsxs(h,{children:[s.jsx(x,{children:s.jsxs(u,{children:[s.jsx(j,{children:"Name"}),s.jsx(j,{children:"Device Type"}),s.jsx(j,{children:"Assigned Areas"}),s.jsx(j,{children:"HA Token"}),s.jsx(j,{children:"Last Seen"}),s.jsx(j,{children:"Status"}),s.jsx(j,{align:"right",children:"Actions"})]})}),s.jsx(m,{children:y.map(i=>{return s.jsxs(u,{hover:!0,children:[s.jsx(j,{children:s.jsxs(n,{display:"flex",alignItems:"center",gap:1,children:[le(i.deviceType),s.jsx(a,{variant:"body2",children:i.name})]})}),s.jsx(j,{children:s.jsx(a,{variant:"body2",sx:{textTransform:"capitalize"},children:i.deviceType})}),s.jsx(j,{children:i.assignedAreas.length>0?s.jsx(n,{display:"flex",gap:.5,flexWrap:"wrap",children:(l=i.assignedAreas,l.map(s=>{var n;return null==(n=e.find(e=>e.id===s))?void 0:n.name}).filter(Boolean)).map((e,n)=>s.jsx(f,{label:e,size:"small"},n))}):s.jsx(a,{variant:"body2",color:"text.secondary",children:"None"})}),s.jsx(j,{children:i.hasHaToken?s.jsx(f,{icon:s.jsx(O,{}),label:"Set",color:"success",size:"small",variant:"outlined"}):s.jsx(f,{label:"Not Set",color:"warning",size:"small",variant:"outlined"})}),s.jsx(j,{children:s.jsx(a,{variant:"body2",children:F(i.lastSeen)})}),s.jsx(j,{children:s.jsx(f,{label:i.status,color:re(i.status),size:"small"})}),s.jsx(j,{align:"right",children:s.jsxs(t,{direction:"row",spacing:1,justifyContent:"flex-end",children:[s.jsx(p,{size:"small",onClick:()=>(e=>{N(e),P(!0)})(i),title:i.hasHaToken?"Update HA token":"Add HA token",color:i.hasHaToken?"success":"warning",children:s.jsx(V,{fontSize:"small"})}),s.jsx(p,{size:"small",onClick:()=>(e=>{N(e),D(!0)})(i),title:"Edit client",children:s.jsx(z,{fontSize:"small"})}),s.jsx(p,{size:"small",onClick:()=>(e=>{N(e),$(!0)})(i),title:"Revoke token",color:"warning",children:s.jsx(W,{fontSize:"small"})}),s.jsx(p,{size:"small",onClick:()=>(e=>{N(e),R(!0)})(i),title:"Delete client",color:"error",children:s.jsx(w,{fontSize:"small"})})]})})]},i.id);var l})})]})})})}),s.jsx(l,{children:s.jsxs(r,{children:[s.jsx(a,{variant:"subtitle2",gutterBottom:!0,children:"Statistics"}),s.jsxs(t,{direction:"row",spacing:2,children:[s.jsx(f,{label:`Total: ${y.length}`,variant:"outlined"}),s.jsx(f,{label:`Online: ${y.filter(e=>"online"===e.status).length}`,color:"success",variant:"outlined"}),s.jsx(f,{label:`Offline: ${y.filter(e=>"offline"===e.status).length}`,variant:"outlined"})]})]})})]}),s.jsx(ce,{open:H,client:E,areas:e,onClose:()=>{D(!1),N(null)},onSave:async(e,s)=>{try{const n=await I.updateClient(e,s);C(s=>s.map(s=>s.id===e?n:s)),X("Client updated successfully","success")}catch(n){throw X(n.message||"Failed to update client","error"),n}}}),s.jsx(de,{open:L,client:E,onClose:()=>{P(!1),N(null)},onSave:async(e,s)=>{try{await I.setClientHaToken(e,s),C(s=>s.map(s=>s.id===e?{...s,hasHaToken:!0,haTokenSetAt:Date.now()}:s)),X("HA token set successfully and sent to client","success")}catch(n){throw X(n.message||"Failed to set HA token","error"),n}}}),s.jsx(oe,{open:J,title:"Revoke Client Token",message:"This will disconnect the client immediately and invalidate its access token. The client will need to be re-paired to reconnect.",confirmText:"Revoke Token",onConfirm:async()=>{if(E){G(!0);try{await I.revokeClientToken(E.id),C(e=>e.map(e=>e.id===E.id?{...e,status:"offline"}:e)),X("Client token revoked successfully","success"),$(!1),N(null)}catch(e){X(e.message||"Failed to revoke token","error")}finally{G(!1)}}},onCancel:()=>{$(!1),N(null)},loading:U}),s.jsx(oe,{open:B,title:"Delete Client",message:"This will permanently delete the client and all its associated data. This action cannot be undone.",confirmText:"Delete Client",onConfirm:async()=>{if(E){G(!0);try{await I.deleteClient(E.id),C(e=>e.filter(e=>e.id!==E.id)),X("Client deleted successfully","success"),R(!1),N(null)}catch(e){X(e.message||"Failed to delete client","error")}finally{G(!1)}}},onCancel:()=>{R(!1),N(null)},loading:U}),s.jsx(v,{open:K.open,autoHideDuration:6e3,onClose:()=>Q({...K,open:!1}),anchorOrigin:{vertical:"bottom",horizontal:"right"},children:s.jsx(i,{onClose:()=>Q({...K,open:!1}),severity:K.severity,variant:"filled",children:K.message})})]})};export{he as ClientManagement};
